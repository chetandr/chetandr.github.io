<!DOCTYPE html>
<html>
	<body>
		<div style="position: relative">
			<video
				id="video"
				width="640"
				height="480"
				autoplay
				style="position: absolute; top: 0px; right: 0px"
			></video>
			<canvas
				id="overlay"
				width="640"
				height="480"
				style="position: absolute; top: 0px; right: 0px"
			></canvas>
			<button
				id="snap"
				style="margin-top: 50px; position: absolute; top: 0px; right: 0px"
			>
				Snap Photo
			</button>
		</div>

		<canvas id="canvas" width="640" height="480"></canvas>
		<div id="debug"></div>
		<img id="photo" />
		<script>
			const video = document.getElementById("video");
			const canvas = document.getElementById("canvas");
			const overlay = document.getElementById("overlay");
			const context = canvas.getContext("2d");
			const ctx = overlay.getContext("2d");
			const img = document.getElementById("photo");
			const a = document.createElement("a");
			document.body.appendChild(a);
			a.style = "display: none";
			function drawEllipse(ctx, x, y, w, h) {
				var kappa = 0.5522848,
					ox = (w / 2) * kappa, // control point offset horizontal
					oy = (h / 2) * kappa, // control point offset vertical
					xe = x + w, // x-end
					ye = y + h, // y-end
					xm = x + w / 2, // x-middle
					ym = y + h / 2; // y-middle

				ctx.beginPath();
				ctx.moveTo(x, ym);

				ctx.bezierCurveTo(x, ym - oy, xm - ox, y, xm, y);
				ctx.bezierCurveTo(xm + ox, y, xe, ym - oy, xe, ym);
				ctx.bezierCurveTo(xe, ym + oy, xm + ox, ye, xm, ye);
				ctx.bezierCurveTo(xm - ox, ye, x, ym + oy, x, ym);
				//ctx.closePath(); // not used correctly, see comments (use to close off open path)
				ctx.stroke();
			}

			// Get access to the camera!
			if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
				console.log("enumerateDevices() not supported.");
				// return;
			}
			const debug = document.getElementById("debug");
			// List cameras and microphones.

			var imageCapture;

			navigator.mediaDevices
				.getUserMedia({ video: true })
				.then((mediaStream) => {
					document.querySelector("video").srcObject = mediaStream;
					let track = "";
					if(mediaStream.getVideoTracks()[1]) {
						track = mediaStream.getVideoTracks()[1];
					} else {
						track = mediaStream.getVideoTracks()[0]
					}
					imageCapture = new ImageCapture(track);
					console.log(imageCapture.getPhotoCapabilities());
					return imageCapture.getPhotoCapabilities();
				});

			var takePhotoButton = document.querySelector("button#snap");
			// var canvas = document.querySelector("canvas");

			takePhotoButton.onclick = takePhoto;

			function takePhoto() {
				imageCapture
					.takePhoto()
					.then(function (blob) {
						console.log("Took photo:", blob);
						img.classList.remove("hidden");
						url = URL.createObjectURL(blob);
						a.href = url;
						a.download = "MyPhoto.png";
						a.click();
						window.URL.revokeObjectURL(url);
					})
					.catch(function (error) {
						console.log("takePhoto() error: ", error);
					});
			}

			ctx.beginPath();
			ctx.lineWidth = 10;
			ctx.strokeStyle = "#FFFFFF";

			drawEllipse(ctx, 200, 75, 300, 400);
			// ctx.stroke();
		</script>
	</body>
</html>
