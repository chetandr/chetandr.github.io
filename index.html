<!DOCTYPE html>
<html>
	<head>
		<meta
			name="viewport"
			content="height=width=device-height, width=device-width, initial-scale=1.0"
		/>
		<style>
			#container {
				position: relative;
			}

			/* video {
				width: 300px;
				display: none;
			} */

			#changeVideo {
				position: absolute;
				top: 10px;
				left: 10px;
				width: 25px;
				height: 25px;
				opacity: 0;
				transition: opacity 0.3s ease;
				cursor: pointer;

				/* Additional styles just to increase visual appeal */
				border-radius: 50%;
				background: #ffffffdd;
				color: red;
				font-weight: bold;
				line-height: 25px;
				text-align: center;
				/* End */
			}

			/* On hovering the video, show the button */
			video:hover ~ #changeVideo {
				opacity: 1;
			}

			#changeVideo:hover {
				opacity: 1;
			}
		</style>
	</head>
	<body>
		<div id="debug"></div>
		<div class="container">
			<div>
				<video id="video" width="640px" height="480px" autoplay></video>
			</div>
			<div id="changeVideo">
				<button
					id="snap"
					style="
						margin-top: 50px;
						top: 0px;
						right: 0px;
						padding: 20px;
						background-color: #3f4756;
						color: #ffffff;
					"
				>
					Capture Image
				</button>
			</div>
		</div>

		<img id="photo" />
		<script>
			const video = document.getElementById("video");

			// const canvas = document.getElementById("canvas");
			// const overlay = document.getElementById("overlay");
			// const context = canvas.getContext("2d");
			// const ctx = overlay.getContext("2d");
			const img = document.getElementById("photo");
			const a = document.createElement("a");
			video.height = window.innerHeight;
			video.width = window.innerWidth;
			document.body.appendChild(a);
			a.style = "display: none";
			function drawEllipse(ctx, x, y, w, h) {
				var kappa = 0.5522848,
					ox = (w / 2) * kappa, // control point offset horizontal
					oy = (h / 2) * kappa, // control point offset vertical
					xe = x + w, // x-end
					ye = y + h, // y-end
					xm = x + w / 2, // x-middle
					ym = y + h / 2; // y-middle

				ctx.beginPath();
				ctx.moveTo(x, ym);

				ctx.bezierCurveTo(x, ym - oy, xm - ox, y, xm, y);
				ctx.bezierCurveTo(xm + ox, y, xe, ym - oy, xe, ym);
				ctx.bezierCurveTo(xe, ym + oy, xm + ox, ye, xm, ye);
				ctx.bezierCurveTo(xm - ox, ye, x, ym + oy, x, ym);
				//ctx.closePath(); // not used correctly, see comments (use to close off open path)
				ctx.stroke();
			}

			// Get access to the camera!
			if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
				console.log("enumerateDevices() not supported.");
				// return;
			}
			const debug = document.getElementById("debug");
			debug.style.display = "none";
			// List cameras and microphones.
			const p = "t";
			let constraint =
				p == "t"
					? {
							video: {
								facingMode: {
									exact: "environment",
								},
								width: { ideal: 4096 },
								height: { ideal: 2160 },
							},
					  }
					: { video: true };
			var imageCapture;
			navigator.mediaDevices
				.enumerateDevices()
				.then(function (devices) {
					devices.forEach(function (device) {
						const div = document.createElement("div");
						div.innerText = JSON.stringify(device);
						div.style.border = "solid 1px #000";
						debug.append(div);
						if (device.label.indexOf("back") > -1) {
							constraint = { deviceId: { exact: device.deviceId } };
						}
					});
				})
				.catch(function (err) {
					console.log(err.name + ": " + err.message);
				});

			document.getElementById("snap").addEventListener("click", function () {
				context.drawImage(video, 0, 0);
			});
			navigator.mediaDevices.getUserMedia(constraint).then((mediaStream) => {
				document.querySelector("video").srcObject = mediaStream;

				let track = "";
				tracks = mediaStream.getVideoTracks();

				let targetTrack = tracks[0];
				tracks.map((t) => {
					const div = document.createElement("div");
					div.innerText = `${t.label}  ${t.label.indexOf("back")}`;
					div.style.border = "solid 1px #000";
					debug.appendChild(div);
					if (t.label.indexOf("back") > -1) {
						targetTrack = t;
					}
				});
				imageCapture = new ImageCapture(targetTrack);
				return imageCapture.getPhotoCapabilities();
			});

			var takePhotoButton = document.querySelector("button#snap");
			// var canvas = document.querySelector("canvas");

			video.onclick = takePhoto;

			function takePhoto() {
				imageCapture
					.takePhoto()
					.then(function (blob) {
						console.log("Took photo:", blob);
						img.classList.remove("hidden");
						url = URL.createObjectURL(blob);
						a.href = url;
						a.download = "MyPhoto.png";
						a.click();
						window.URL.revokeObjectURL(url);
					})
					.catch(function (error) {
						console.log("takePhoto() error: ", error);
					});
			}

			// ctx.beginPath();
			// ctx.lineWidth = 10;
			// ctx.strokeStyle = "#FFFFFF";

			// drawEllipse(ctx, 200, 75, 300, 400);
			// ctx.stroke();
		</script>
	</body>
</html>
